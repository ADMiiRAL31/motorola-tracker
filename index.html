<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>üì± Motorola Tracker</title>
  <style>
    :root{
      --bg1:#667eea;
      --bg2:#764ba2;
      --card:#ffffff;
      --txt:#333333;
      --muted:#6b7280;
      --primary:#2563eb;
      --primary-2:#1d4ed8;
      --ok-bg:#d1fae5;
      --ok:#059669;
      --warn-bg:#fef3c7;
      --warn:#d97706;
      --err-bg:#fee2e2;
      --err:#dc2626;
      --shade:#e5e7eb;
      --soft:#f9fafb;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height: 100vh;
      padding: 10px;
      color: var(--txt);
    }

    .container{ max-width: 1200px; margin: 0 auto; }

    header.header{
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      text-align: center;
    }

    .header h1{ font-size: 24px; color: var(--primary); margin-bottom: 8px; }
    .header p{ color: var(--muted); margin-bottom: 10px; }

    .controls{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

    .date-input{
      margin-top: 5px;
      padding: 10px 12px;
      border: 2px solid var(--shade);
      border-radius: 8px;
      font-size: 16px;
    }

    .btn{
      background: var(--ok);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: transform .06s ease;
    }
    .btn:active{ transform: translateY(1px); }

    .btn-secondary{
      background: var(--primary);
    }

    .grid{ display: grid; gap: 20px; margin-bottom: 20px; }
    @media (min-width: 768px){ .grid-2{ grid-template-columns: 1fr 1fr; } }

    .card{
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .card-title{
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .product-row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--soft);
      border-radius: 10px;
      margin-bottom: 12px;
      border: 1px solid var(--shade);
    }

    .product-name{ flex: 1; font-weight: 600; font-size: 14px; }

    .counter{ display:flex; align-items:center; gap:12px; }

    .btn-circle{
      width: 40px; height: 40px; border: none; border-radius: 50%;
      font-size: 18px; font-weight: 800; cursor: pointer;
      display:flex; align-items:center; justify-content:center;
      transition: opacity .2s ease;
    }

    .btn-minus{ background: var(--err-bg); color: var(--err); }
    .btn-minus:hover:not(:disabled){ opacity:.9; }
    .btn-minus:disabled{ opacity:.45; cursor:not-allowed; }

    .btn-plus{ background: var(--ok-bg); color: var(--ok); }
    .btn-plus:hover{ opacity:.9; }

    .count{ font-size: 18px; font-weight: 800; min-width: 30px; text-align:center; }

    .total-box{
      background: linear-gradient(135deg, #3b82f6, var(--primary-2));
      color: white; text-align:center; padding: 20px; border-radius: 12px; margin-top: 8px;
    }
    .total-number{ font-size: 32px; font-weight: 900; }

    .stock-input{
      width: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; text-align: center; margin-right: 10px;
    }

    .status-badge{
      padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 800;
    }
    .status-rupture{ background: var(--err-bg); color: var(--err); }
    .status-faible{ background: var(--warn-bg); color: var(--warn); }
    .status-ok{ background: var(--ok-bg); color: var(--ok); }

    .textarea{
      width:100%; padding: 12px; border:1px solid #d1d5db; border-radius:8px;
      resize: vertical; min-height: 110px; font: inherit; font-size: 14px;
    }

    .report-box{
      background:#f8fafc; padding: 15px; border-radius: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px; line-height: 1.5; white-space: pre-wrap; max-height: 300px; overflow-y: auto; border:1px solid #e2e8f0;
    }

    .copy-btn{
      background: #3b82f6; color:#fff; border:none; padding:8px 12px; border-radius: 6px; font-size:12px; cursor:pointer; margin-bottom:10px;
    }
    .copy-btn:hover{ background: var(--primary); }

    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; animation: none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header" role="banner">
      <h1>üì± Suivi Ventes Motorola</h1>
      <p>Fnac Toulouse Wilson ‚Äî Vendeur R√©f√©rent</p>
      <div class="controls" role="group" aria-label="Contr√¥les g√©n√©raux">
        <label for="currentDate" class="visually-hidden" style="position:absolute;left:-9999px;">Date</label>
        <input type="date" id="currentDate" class="date-input" />
        <button type="button" class="btn" id="btn-export-json">üì§ Export JSON</button>
        <button type="button" class="btn btn-secondary" id="btn-export-csv">üìë Export CSV</button>
      </div>
    </header>

    <!-- Ventes et Stock -->
    <main class="grid grid-2" role="main">
      <!-- Ventes -->
      <section class="card" aria-labelledby="title-ventes">
        <div class="card-title" id="title-ventes">üìà Ventes du jour</div>

        <div class="product-row">
          <div class="product-name">Motorola G15</div>
          <div class="counter">
            <button type="button" class="btn-circle btn-minus" aria-label="Retirer 1 Motorola G15" onclick="updateSales('g15', -1)" id="btn-minus-g15">‚àí</button>
            <div class="count" id="count-g15">0</div>
            <button type="button" class="btn-circle btn-plus" aria-label="Ajouter 1 Motorola G15" onclick="updateSales('g15', 1)">+</button>
          </div>
        </div>

        <div class="product-row">
          <div class="product-name">Motorola G15 Power (pack)</div>
          <div class="counter">
            <button type="button" class="btn-circle btn-minus" aria-label="Retirer 1 Motorola G15 Power (pack)" onclick="updateSales('g15pack', -1)" id="btn-minus-g15pack">‚àí</button>
            <div class="count" id="count-g15pack">0</div>
            <button type="button" class="btn-circle btn-plus" aria-label="Ajouter 1 Motorola G15 Power (pack)" onclick="updateSales('g15pack', 1)">+</button>
          </div>
        </div>

        <div class="product-row">
          <div class="product-name">Motorola G56 (pack)</div>
          <div class="counter">
            <button type="button" class="btn-circle btn-minus" aria-label="Retirer 1 Motorola G56 (pack)" onclick="updateSales('g56pack', -1)" id="btn-minus-g56pack">‚àí</button>
            <div class="count" id="count-g56pack">0</div>
            <button type="button" class="btn-circle btn-plus" aria-label="Ajouter 1 Motorola G56 (pack)" onclick="updateSales('g56pack', 1)">+</button>
          </div>
        </div>

        <div class="product-row">
          <div class="product-name">Chargeur 33W</div>
          <div class="counter">
            <button type="button" class="btn-circle btn-minus" aria-label="Retirer 1 Chargeur 33W" onclick="updateSales('chargeur', -1)" id="btn-minus-chargeur">‚àí</button>
            <div class="count" id="count-chargeur">0</div>
            <button type="button" class="btn-circle btn-plus" aria-label="Ajouter 1 Chargeur 33W" onclick="updateSales('chargeur', 1)">+</button>
          </div>
        </div>

        <div class="product-row">
          <div class="product-name">Accessoires divers</div>
          <div class="counter">
            <button type="button" class="btn-circle btn-minus" aria-label="Retirer 1 Accessoires divers" onclick="updateSales('accessoires', -1)" id="btn-minus-accessoires">‚àí</button>
            <div class="count" id="count-accessoires">0</div>
            <button type="button" class="btn-circle btn-plus" aria-label="Ajouter 1 Accessoires divers" onclick="updateSales('accessoires', 1)">+</button>
          </div>
        </div>

        <div class="total-box" aria-live="polite">
          <div class="total-number" id="total-sales" aria-live="polite">0</div>
          <div>Total ventes</div>
          <div id="smartphone-count" aria-live="polite" style="font-size:14px;margin-top:5px;"></div>
        </div>
      </section>

      <!-- Stock -->
      <section class="card" aria-labelledby="title-stock">
        <div class="card-title" id="title-stock">üì¶ Stock disponible</div>

        <div class="product-row">
          <div class="product-name"><label for="stock-g15">Motorola G15</label></div>
          <div style="display:flex;align-items:center;">
            <input type="number" class="stock-input" value="0" min="0" id="stock-g15" onchange="updateStock('g15', this.value)" inputmode="numeric" />
            <span class="status-badge status-rupture" id="status-g15">Rupture</span>
          </div>
        </div>

        <div class="product-row">
          <div class="product-name"><label for="stock-g15pack">Motorola G15 Power (pack)</label></div>
          <div style="display:flex;align-items:center;">
            <input type="number" class="stock-input" value="0" min="0" id="stock-g15pack" onchange="updateStock('g15pack', this.value)" inputmode="numeric" />
            <span class="status-badge status-rupture" id="status-g15pack">Rupture</span>
          </div>
        </div>

        <div class="product-row">
          <div class="product-name"><label for="stock-g56pack">Motorola G56 (pack)</label></div>
          <div style="display:flex;align-items:center;">
            <input type="number" class="stock-input" value="0" min="0" id="stock-g56pack" onchange="updateStock('g56pack', this.value)" inputmode="numeric" />
            <span class="status-badge status-rupture" id="status-g56pack">Rupture</span>
          </div>
        </div>

        <div class="product-row">
          <div class="product-name"><label for="stock-chargeur">Chargeur 33W</label></div>
          <div style="display:flex;align-items:center;">
            <input type="number" class="stock-input" value="0" min="0" id="stock-chargeur" onchange="updateStock('chargeur', this.value)" inputmode="numeric" />
            <span class="status-badge status-rupture" id="status-chargeur">Rupture</span>
          </div>
        </div>
      </section>
    </main>

    <!-- Notes -->
    <section class="grid grid-2" aria-labelledby="title-notes">
      <div class="card">
        <div class="card-title" id="title-notes">üë• Observations terrain</div>
        <textarea id="observations" class="textarea" placeholder="Flux client, contexte, probl√®mes rencontr√©s‚Ä¶"></textarea>
      </div>
      <div class="card">
        <div class="card-title">üí¨ Verbatims clients</div>
        <textarea id="verbatims" class="textarea" placeholder="Retours clients positifs et n√©gatifs‚Ä¶"></textarea>
      </div>
    </section>

    <section class="grid grid-2">
      <div class="card">
        <div class="card-title">üîß Interventions techniques</div>
        <textarea id="interventions" class="textarea" placeholder="SAV, r√©solution probl√®mes‚Ä¶"></textarea>
      </div>
      <div class="card">
        <div class="card-title">üìù R√©sum√© personnalis√©</div>
        <textarea id="dailySummary" class="textarea" placeholder="Ton commentaire personnel sur la journ√©e‚Ä¶"></textarea>
      </div>
    </section>

    <!-- Rapports -->
    <section class="grid grid-2" aria-labelledby="title-rapports">
      <div class="card">
        <div class="card-title" id="title-rapports">üìÑ R√©sum√© quotidien</div>
        <button type="button" class="copy-btn" onclick="copyToClipboard('daily-report')">Copier</button>
        <div id="daily-report" class="report-box" role="region" aria-live="polite"></div>
      </div>
      <div class="card">
        <div class="card-title">üìä Rapport professionnel</div>
        <button type="button" class="copy-btn" onclick="copyToClipboard('professional-report')">Copier</button>
        <div id="professional-report" class="report-box" role="region" aria-live="polite"></div>
      </div>
    </section>
  </div>

  <script>
    // ---------- Donn√©es ----------
    const DEBUG = false;

    const initialSales = { g15:0, g15pack:0, g56pack:0, chargeur:0, accessoires:0 };
    const initialStock = { g15:0, g15pack:0, g56pack:0, chargeur:0 };

    let sales = { ...initialSales };
    // ‚ö†Ô∏è le stock est d√©sormais GLOBAL, pas par jour :
    let stock = null;

    let currentDate = new Date().toISOString().split('T')[0];
    let isInit = false; // √©vite de sauvegarder pendant l'initialisation

    const productNames = {
      g15: 'Motorola G15',
      g15pack: 'Motorola G15 Power (pack)',
      g56pack: 'Motorola G56 (pack)',
      chargeur: 'Chargeur 33W',
      accessoires: 'Accessoires divers'
    };

    // ---------- Stock GLOBAL (persistant) ----------
    const GLOBAL_STOCK_KEY = 'motorola-stock';

    function loadGlobalStock(){
      try{
        const raw = localStorage.getItem(GLOBAL_STOCK_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        stock = { ...initialStock, ...(parsed||{}) };
      }catch(e){
        console.warn('Stock global illisible', e);
        stock = { ...initialStock };
      }
    }
    function saveGlobalStock(){
      try{ localStorage.setItem(GLOBAL_STOCK_KEY, JSON.stringify(stock)); }
      catch(e){ console.warn('Stock global non sauvegard√©', e); }
    }

    // ---------- Utils ----------
    const log = (...args) => { if (DEBUG) console.log(...args); };

    function safeDateStr(dateStr){
      const d = new Date(dateStr);
      return isNaN(d.getTime()) ? new Date() : d;
    }

    function storageKey(dateStr){ return `motorola-${dateStr}`; }

    function setStatusBadge(key, qty){
      const el = document.getElementById(`status-${key}`);
      if (!el) return;
      let cls = 'status-ok', txt = 'OK';
      if (qty === 0){ cls = 'status-rupture'; txt = 'Rupture'; }
      else if (qty < 5){ cls = 'status-faible'; txt = 'Faible'; }
      el.className = `status-badge ${cls}`;
      el.textContent = txt;
    }

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('currentDate').value = currentDate;
      document.getElementById('btn-export-json').addEventListener('click', exportJSON);
      document.getElementById('btn-export-csv').addEventListener('click', exportCSV);

      loadGlobalStock(); // ‚¨ÖÔ∏è charge le stock global
      setupEvents();

      // applique le stock global dans l'UI (ne d√©pend pas du jour)
      Object.keys(stock).forEach(key => {
        const input = document.getElementById(`stock-${key}`);
        if (input){ input.value = stock[key]||0; setStatusBadge(key, stock[key]||0); }
      });

      isInit = true;
      loadData(); // ‚¨ÖÔ∏è ne charge que les ventes/notes du jour
      isInit = false;

      updateTotals();
      updateReports();
      log('‚úÖ Application pr√™te');
    });

    function setupEvents(){
      document.getElementById('currentDate').addEventListener('change', (e) => {
        currentDate = e.target.value || new Date().toISOString().split('T')[0];
        isInit = true;
        loadData(); // ‚¨ÖÔ∏è pas de changement de stock ici !
        isInit = false;
        updateTotals();
        updateReports();
      });

      ['observations', 'verbatims', 'interventions', 'dailySummary'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => {
          saveData();
          updateReports();
        });
      });
    }

    // ---------- Ventes (impacte le stock GLOBAL) ----------
    function updateSales(productKey, change){
      const current = sales[productKey] || 0;

      if (change > 0){
        // ne vend pas au-del√† du stock (sauf "accessoires" qui n'a pas de stock suivi)
        if (productKey in stock){
          const dispo = stock[productKey] || 0;
          if (dispo <= 0){ alert('Stock insuffisant'); return; }
          stock[productKey] = dispo - 1;          // d√©cr√©mente le stock global
          const input = document.getElementById(`stock-${productKey}`);
          if (input) input.value = stock[productKey];
          setStatusBadge(productKey, stock[productKey]);
          saveGlobalStock();
        }
        sales[productKey] = current + 1;
      } else if (change < 0 && current > 0){
        sales[productKey] = current - 1;
        if (productKey in stock){
          stock[productKey] = (stock[productKey] || 0) + 1; // rend 1 au stock global
          const input = document.getElementById(`stock-${productKey}`);
          if (input) input.value = stock[productKey];
          setStatusBadge(productKey, stock[productKey]);
          saveGlobalStock();
        }
      }

      const next = sales[productKey] || 0;
      const countEl = document.getElementById(`count-${productKey}`);
      if (countEl) countEl.textContent = next;

      const minusBtn = document.getElementById(`btn-minus-${productKey}`);
      if (minusBtn) minusBtn.disabled = next === 0;

      updateTotals();
      saveData();      // ‚¨ÖÔ∏è on ne sauve que les ventes/notes du jour
      updateReports();
    }

    // ---------- Stock GLOBAL (manuel) ----------
    function updateStock(productKey, value){
      const qty = Math.max(0, parseInt(value, 10) || 0);
      stock[productKey] = qty;      // ‚¨ÖÔ∏è met √† jour le stock GLOBAL
      setStatusBadge(productKey, qty);
      if (!isInit) saveGlobalStock();
    }

    // ---------- Totaux ----------
    function updateTotals(){
      const totalSales = Object.values(sales).reduce((s, n) => s + n, 0);
      const smartphoneSales = (sales.g15||0) + (sales.g15pack||0) + (sales.g56pack||0);

      const totalEl = document.getElementById('total-sales');
      const smartEl = document.getElementById('smartphone-count');

      if (totalEl) totalEl.textContent = totalSales;
      if (smartEl) smartEl.textContent = smartphoneSales > 0 ? `dont ${smartphoneSales} smartphones` : '';
    }

    // ---------- Rapports ----------
    function generateDailySummary(){
      const totalSales = Object.values(sales).reduce((s, n) => s + n, 0);
      const smartphoneSales = (sales.g15||0) + (sales.g15pack||0) + (sales.g56pack||0);

      const salesList = Object.entries(sales)
        .filter(([, count]) => count > 0)
        .map(([key, count]) => `‚Ä¢ ${productNames[key]} : ${count} vendu${count > 1 ? 's' : ''}`)
        .join('\n');

      const dateObj = safeDateStr(currentDate);
      const dateStr = dateObj.toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

      let summary = `**R√©sum√© des ventes ‚Äì ${dateStr} ‚Äì Fnac Toulouse Wilson**\n\n`;
      summary += salesList ? (salesList + '\n\n') : '‚Ä¢ Aucune vente enregistr√©e\n\n';
      summary += `Total : ${totalSales} ventes${smartphoneSales > 0 ? ` dont ${smartphoneSales} smartphones` : ''}\n\n`;
      summary += `**R√©sum√© de la journ√©e :**\n`;

      const dailySummaryText = (document.getElementById('dailySummary').value || '').trim();
      if (dailySummaryText){
        summary += dailySummaryText;
      } else if (totalSales === 0){
        summary += "D√©but de journ√©e : mise en place, observation du flux, on s'adapte au stock.";
      } else {
        summary += "Bilan positif : opportunit√©s trait√©es et conversion maintenue selon le stock disponible.";
      }
      return summary;
    }

    function generateProfessionalReport(){
      const totalSales = Object.values(sales).reduce((s, n) => s + n, 0);
      const smartphoneSales = (sales.g15||0) + (sales.g15pack||0) + (sales.g56pack||0);
      const observations = (document.getElementById('observations').value || '').trim();
      const verbatims = (document.getElementById('verbatims').value || '').trim();
      const interventions = (document.getElementById('interventions').value || '').trim();

      const dateStr = safeDateStr(currentDate).toLocaleDateString('fr-FR');
      let report = `**Rapport Professionnel ‚Äì ${dateStr}**\n\n`;

      report += `**Points positifs :**\n`;
      if (totalSales > 0){
        report += `‚Ä¢ Performance commerciale : ${totalSales} ventes r√©alis√©es\n`;
        if (smartphoneSales > 0) report += `‚Ä¢ Efficacit√© smartphones : ${smartphoneSales} unit√©s vendues\n`;
        report += `‚Ä¢ Opportunit√©s client exploit√©es dans le contexte du jour\n`;
      } else {
        report += `‚Ä¢ Pr√©sence et animation commerciale maintenues\n`;
        report += `‚Ä¢ Pr√©paration/qualification du flux pour les jours suivants\n`;
      }

      report += `\n**Points n√©gatifs :**\n`;
      const stockIssues = Object.entries(stock).filter(([, qty]) => qty === 0);
      if (stockIssues.length > 0){
        report += `‚Ä¢ Contraintes d'approvisionnement sur ${stockIssues.length} r√©f√©rence(s)\n`;
        report += `‚Ä¢ Ventes perdues potentielles li√©es aux ruptures\n`;
      }
      if (observations.toLowerCase().includes('stock') || observations.toLowerCase().includes('rupture')){
        report += `‚Ä¢ Demande non servie faute de disponibilit√© produits\n`;
      }

      report += `\n**Contexte :**\n`;
      if (observations) report += observations + '\n';
      report += `‚Ä¢ Approvisionnement : aligner flux et demande pour maximiser la conversion\n`;

      if (verbatims) report += `\n**Verbatims clients :**\n${verbatims}\n`;
      if (interventions) report += `\n**Interventions techniques :**\n${interventions}`;

      return report;
    }

    function updateReports(){
      const daily = document.getElementById('daily-report');
      const pro = document.getElementById('professional-report');
      if (daily) daily.textContent = generateDailySummary();
      if (pro) pro.textContent = generateProfessionalReport();
    }

    // ---------- Sauvegarde (par jour) ----------
    // ‚ö†Ô∏è On NE sauvegarde plus le stock dans la journ√©e (le stock est global).
    function saveData(){
      const data = {
        sales,
        observations: document.getElementById('observations').value || '',
        verbatims: document.getElementById('verbatims').value || '',
        interventions: document.getElementById('interventions').value || '',
        dailySummary: document.getElementById('dailySummary').value || ''
      };
      try{
        localStorage.setItem(storageKey(currentDate), JSON.stringify(data));
        log('üíæ Donn√©es jour sauvegard√©es');
      }catch(e){
        console.warn('Stockage indisponible :', e);
      }
    }

    function loadData(){
      // reset ventes et zones texte pour la date choisie
      sales = { ...initialSales };

      ['observations','verbatims','interventions','dailySummary'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

      // ne touche PAS au stock global ici : on garde ce qui est en m√©moire
      Object.keys(stock).forEach(key => {
        const input = document.getElementById(`stock-${key}`);
        if (input){ input.value = stock[key] || 0; setStatusBadge(key, stock[key] || 0); }
      });

      // r√©initialise l'affichage des compteurs ventes
      Object.keys(sales).forEach(key => {
        const countEl = document.getElementById(`count-${key}`);
        if (countEl) countEl.textContent = 0;
        const minusBtn = document.getElementById(`btn-minus-${key}`);
        if (minusBtn) minusBtn.disabled = true;
      });

      const saved = localStorage.getItem(storageKey(currentDate));
      if (!saved){ log('üìÖ Nouvelle journ√©e'); return; }

      try{
        const data = JSON.parse(saved);

        // applique ventes sauvegard√©es (stock reste GLOBAL)
        sales = { ...initialSales, ...(data.sales || {}) };

        Object.keys(sales).forEach(key => {
          const val = sales[key] || 0;
          const countEl = document.getElementById(`count-${key}`);
          if (countEl) countEl.textContent = val;
          const minusBtn = document.getElementById(`btn-minus-${key}`);
          if (minusBtn) minusBtn.disabled = val === 0;
        });

        if (data.observations) document.getElementById('observations').value = data.observations;
        if (data.verbatims) document.getElementById('verbatims').value = data.verbatims;
        if (data.interventions) document.getElementById('interventions').value = data.interventions;
        if (data.dailySummary) document.getElementById('dailySummary').value = data.dailySummary;

        log('üìÇ Donn√©es charg√©es pour', currentDate);
      }catch(e){
        console.warn('Erreur de lecture des donn√©es :', e);
      }
    }

    // ---------- Copier ----------
    function copyToClipboard(elementId){
      const el = document.getElementById(elementId);
      const text = el ? el.textContent : '';
      if (!text) return;

      if (navigator.clipboard?.writeText){
        navigator.clipboard.writeText(text).then(() => alert('üìã Copi√© !'));
      } else {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        alert('üìã Copi√© !');
      }
    }

    // ---------- Export ----------
    // L‚Äôexport inclut un *snapshot* du stock global au moment de l‚Äôexport.
    function buildPayload(){
      return {
        date: currentDate,
        sales,
        stock: { ...stock }, // snapshot du stock GLOBAL
        observations: document.getElementById('observations').value || '',
        verbatims: document.getElementById('verbatims').value || '',
        interventions: document.getElementById('interventions').value || '',
        dailySummary: document.getElementById('dailySummary').value || '',
        dailyReport: generateDailySummary(),
        professionalReport: generateProfessionalReport()
      };
    }

    function downloadBlob(content, filename, type='application/octet-stream'){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    function exportJSON(){
      const data = buildPayload();
      downloadBlob(JSON.stringify(data, null, 2), `motorola-${currentDate}.json`, 'application/json');
      alert('üì§ Export JSON termin√© !');
    }

    function exportCSV(){
      const data = buildPayload();
      const lines = [
        ['Date', data.date],
        [],
        ['Produit','Ventes','Stock'],
        ['Motorola G15', data.sales.g15, data.stock.g15],
        ['Motorola G15 Power (pack)', data.sales.g15pack, data.stock.g15pack],
        ['Motorola G56 (pack)', data.sales.g56pack, data.stock.g56pack],
        ['Chargeur 33W', data.sales.chargeur, data.stock.chargeur],
        ['Accessoires divers', data.sales.accessoires, '‚Äî'],
        [],
        ['Observations', (data.observations||'').replace(/\n/g,' ')],
        ['Verbatims', (data.verbatims||'').replace(/\n/g,' ')],
        ['Interventions', (data.interventions||'').replace(/\n/g,' ')],
        [],
        ['R√©sum√© quotidien', (data.dailyReport||'').replace(/\n/g,' ')],
        ['Rapport professionnel', (data.professionalReport||'').replace(/\n/g,' ')]
      ];

      const csv = lines.map(row => row.map(cell => {
        if (cell === null || cell === undefined) return '';
        const s = String(cell);
        return /[;"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(';')).join('\n');

      downloadBlob(csv, `motorola-${currentDate}.csv`, 'text/csv;charset=utf-8');
      alert('üìë Export CSV termin√© !');
    }
  </script>
</body>
</html>