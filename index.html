<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>üì± Motorola Tracker</title>
  <style>
    :root{
      --bg1:#667eea;
      --bg2:#764ba2;
      --card:#ffffff;
      --txt:#333333;
      --muted:#6b7280;
      --primary:#2563eb;
      --primary-2:#1d4ed8;
      --ok-bg:#d1fae5;
      --ok:#059669;
      --warn-bg:#fef3c7;
      --warn:#d97706;
      --err-bg:#fee2e2;
      --err:#dc2626;
      --shade:#e5e7eb;
      --soft:#f9fafb;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height: 100vh;
      padding: 10px;
      color: var(--txt);
    }

    .container{ max-width: 1200px; margin: 0 auto; }

    header.header{
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      text-align: center;
    }

    .header h1{ font-size: 24px; color: var(--primary); margin-bottom: 8px; }
    .header p{ color: var(--muted); margin-bottom: 10px; }

    .controls{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

    .date-input{
      margin-top: 5px;
      padding: 10px 12px;
      border: 2px solid var(--shade);
      border-radius: 8px;
      font-size: 16px;
    }

    .btn{
      background: var(--ok);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: transform .06s ease;
    }
    .btn:active{ transform: translateY(1px); }

    .btn-secondary{
      background: var(--primary);
    }

    .grid{ display: grid; gap: 20px; margin-bottom: 20px; }
    @media (min-width: 768px){ .grid-2{ grid-template-columns: 1fr 1fr; } }

    .card{
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .card-title{
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-subtitle{
      font-weight:700; font-size:14px; color:#111827; margin:12px 4px 10px;
    }

    .product-row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--soft);
      border-radius: 10px;
      margin-bottom: 12px;
      border: 1px solid var(--shade);
    }

    .product-name{ flex: 1; font-weight: 600; font-size: 14px; }

    .counter{ display:flex; align-items:center; gap:12px; }

    .btn-circle{
      width: 40px; height: 40px; border: none; border-radius: 50%;
      font-size: 18px; font-weight: 800; cursor: pointer;
      display:flex; align-items:center; justify-content:center;
      transition: opacity .2s ease;
    }

    .btn-minus{ background: var(--err-bg); color: var(--err); }
    .btn-minus:hover:not(:disabled){ opacity:.9; }
    .btn-minus:disabled{ opacity:.45; cursor:not-allowed; }

    .btn-plus{ background: var(--ok-bg); color: var(--ok); }
    .btn-plus:hover{ opacity:.9; }

    .count{ font-size: 18px; font-weight: 800; min-width: 30px; text-align:center; }

    .total-box{
      background: linear-gradient(135deg, #3b82f6, var(--primary-2));
      color: white; text-align:center; padding: 20px; border-radius: 12px; margin-top: 8px;
    }
    .total-number{ font-size: 32px; font-weight: 900; }

    .stock-input{
      width: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; text-align: center; margin-right: 10px;
    }

    .status-badge{
      padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 800;
    }
    .status-rupture{ background: var(--err-bg); color: var(--err); }
    .status-faible{ background: var(--warn-bg); color: var(--warn); }
    .status-ok{ background: var(--ok-bg); color: var(--ok); }

    .textarea{
      width:100%; padding: 12px; border:1px solid #d1d5db; border-radius:8px;
      resize: vertical; min-height: 110px; font: inherit; font-size: 14px;
    }

    .report-box{
      background:#f8fafc; padding: 15px; border-radius: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px; line-height: 1.5; white-space: pre-wrap; max-height: 300px; overflow-y: auto; border:1px solid #e2e8f0;
    }

    .copy-btn{
      background: #3b82f6; color:#fff; border:none; padding:8px 12px; border-radius: 6px; font-size:12px; cursor:pointer; margin-bottom:10px;
    }
    .copy-btn:hover{ background: var(--primary); }

    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; animation: none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header" role="banner">
      <h1>üì± Suivi Ventes Motorola</h1>
      <p>Fnac Toulouse Wilson ‚Äî Vendeur R√©f√©rent</p>
      <div class="controls" role="group" aria-label="Contr√¥les g√©n√©raux">
        <label for="currentDate" class="visually-hidden" style="position:absolute;left:-9999px;">Date</label>
        <input type="date" id="currentDate" class="date-input" />
        <button type="button" class="btn" id="btn-export-json">üì§ Export JSON</button>
        <button type="button" class="btn btn-secondary" id="btn-export-csv">üìë Export CSV</button>
      </div>
    </header>

    <!-- Ventes et Stock -->
    <main class="grid grid-2" role="main">
      <!-- Ventes -->
      <section class="card" aria-labelledby="title-ventes">
        <div class="card-title" id="title-ventes">üìà Ventes du jour</div>
        <div id="sales-list"></div>

        <div class="total-box" aria-live="polite">
          <div class="total-number" id="total-sales" aria-live="polite">0</div>
          <div>Total ventes</div>
          <div id="smartphone-count" aria-live="polite" style="font-size:14px;margin-top:5px;"></div>
        </div>

        <!-- ‚úÖ Nouveau : bouton r√©initialiser ventes du jour -->
        <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
          <button type="button" class="btn btn-secondary" id="btn-reset-sales">
            ‚ôªÔ∏è R√©initialiser ventes (jour)
          </button>
        </div>
      </section>

      <!-- Stock -->
      <section class="card" aria-labelledby="title-stock">
        <div class="card-title" id="title-stock">üì¶ Stock disponible</div>
        <div id="stock-list"></div>
      </section>
    </main>

    <!-- Notes -->
    <section class="grid grid-2" aria-labelledby="title-notes">
      <div class="card">
        <div class="card-title" id="title-notes">üë• Observations terrain</div>
        <textarea id="observations" class="textarea" placeholder="Flux client, contexte, probl√®mes rencontr√©s‚Ä¶"></textarea>
      </div>
      <div class="card">
        <div class="card-title">üí¨ Verbatims clients</div>
        <textarea id="verbatims" class="textarea" placeholder="Retours clients positifs et n√©gatifs‚Ä¶"></textarea>
      </div>
    </section>

    <section class="grid grid-2">
      <div class="card">
        <div class="card-title">üîß Interventions techniques</div>
        <textarea id="interventions" class="textarea" placeholder="SAV, r√©solution probl√®mes‚Ä¶"></textarea>
      </div>
      <div class="card">
        <div class="card-title">üìù R√©sum√© personnalis√©</div>
        <textarea id="dailySummary" class="textarea" placeholder="Ton commentaire personnel sur la journ√©e‚Ä¶"></textarea>
      </div>
    </section>

    <!-- Rapports -->
    <section class="grid grid-2" aria-labelledby="title-rapports">
      <div class="card">
        <div class="card-title" id="title-rapports">üìÑ R√©sum√© quotidien</div>
        <button type="button" class="copy-btn" onclick="copyToClipboard('daily-report')">Copier</button>
        <div id="daily-report" class="report-box" role="region" aria-live="polite"></div>
      </div>
      <div class="card">
        <div class="card-title">üìä Rapport professionnel</div>
        <button type="button" class="copy-btn" onclick="copyToClipboard('professional-report')">Copier</button>
        <div id="professional-report" class="report-box" role="region" aria-live="polite"></div>
      </div>
    </section>
  </div>

  <script>
    // ========= Produits =========
    const PRODUCTS = [
      // GAMME G
      {key:'g15',       name:'G15',                       cat:'G',      type:'phone', stock:true},
      {key:'g15p',      name:'G15 Power',                 cat:'G',      type:'phone', stock:true},
      {key:'g15ppack',  name:'G15 Power (pack)',          cat:'G',      type:'phone', stock:true},
      {key:'g56',       name:'G56',                       cat:'G',      type:'phone', stock:true},
      {key:'g56pack',   name:'G56 (pack)',                cat:'G',      type:'phone', stock:true},
      {key:'g86',       name:'G86',                       cat:'G',      type:'phone', stock:true},

      // GAMME EDGE
      {key:'e60',       name:'Edge 60',                   cat:'EDGE',   type:'phone', stock:true},
      {key:'e60f',      name:'Edge 60 Fusion',            cat:'EDGE',   type:'phone', stock:true},
      {key:'e60fpack',  name:'Edge 60 Fusion (pack)',     cat:'EDGE',   type:'phone', stock:true},
      {key:'e60pro',    name:'Edge 60 Pro',               cat:'EDGE',   type:'phone', stock:true},

      // GAMME E
      {key:'e15',       name:'E15 (64 Go √† 102‚Ç¨)',        cat:'E',      type:'phone', stock:true},

      // ACCESSOIRES ‚Äî CHARGEURS
      {key:'c33',       name:'Chargeur 33W',              cat:'CHARGEUR', type:'acc', stock:true},
      {key:'c68',       name:'Chargeur 68W',              cat:'CHARGEUR', type:'acc', stock:true},
      {key:'c125',      name:'Chargeur 125W (simple)',    cat:'CHARGEUR', type:'acc', stock:true},
      {key:'c125d',     name:'Chargeur 125W double',      cat:'CHARGEUR', type:'acc', stock:true},

      // ACCESSOIRES ‚Äî AUDIO
      {key:'budsloop',  name:'Moto Buds Loop',            cat:'AUDIO', type:'acc', stock:true},

      // ACCESSOIRES ‚Äî TRACKING
      {key:'mototag',   name:'Moto Tag',                  cat:'TRACKING', type:'acc', stock:true},
    ];

    // ========= Donn√©es / cl√©s =========
    const GLOBAL_STOCK_KEY = 'motorola-stock'; // stock GLOBAL persistant
    const TODAY = new Date().toISOString().split('T')[0];

    let currentDate = TODAY;
    let isInit = false;

    // ventes par jour
    let sales = Object.fromEntries(PRODUCTS.map(p => [p.key, 0]));
    // stock global
    let stock = Object.fromEntries(PRODUCTS.filter(p=>p.stock).map(p => [p.key, 0]));

    // ========= Utils =========
    const $ = (id) => document.getElementById(id);
    const storageKey = (date) => `motorola-${date}`;
    const log = (...a)=>{ /* DEBUG ? console.log(...a) : */ 0; };

    function safeDateStr(dateStr){
      const d = new Date(dateStr);
      return isNaN(d.getTime()) ? new Date() : d;
    }

    // ========= Stock GLOBAL =========
    function loadGlobalStock(){
      try{
        const raw = localStorage.getItem(GLOBAL_STOCK_KEY);
        if (raw){
          const parsed = JSON.parse(raw);
          stock = { ...stock, ...parsed };
        }
      }catch(e){ console.warn('Stock global illisible', e); }
    }
    function saveGlobalStock(){
      try{ localStorage.setItem(GLOBAL_STOCK_KEY, JSON.stringify(stock)); }
      catch(e){ console.warn('Stock global non sauvegard√©', e); }
    }

    // ========= Badges de statut =========
    function setStatusBadge(key, qty){
      const el = $(`status-${key}`);
      if (!el) return;
      let cls = 'status-ok', txt = 'OK';
      if (qty === 0){ cls = 'status-rupture'; txt = 'Rupture'; }
      else if (qty < 5){ cls = 'status-faible'; txt = 'Faible'; }
      el.className = `status-badge ${cls}`;
      el.textContent = txt;
    }

    // ========= Rendu UI (m√™me design) =========
    function sectionTitle(txt){
      const el = document.createElement('div');
      el.className = 'section-subtitle';
      el.textContent = txt;
      return el;
    }

    function render(){
      // Ventes
      const salesRoot = $('sales-list');
      salesRoot.innerHTML = '';
      const groupsV = [
        {label:'SMARTPHONES MOTOROLA ‚Äî GAMME G', keys: PRODUCTS.filter(p=>p.cat==='G')},
        {label:'SMARTPHONES MOTOROLA ‚Äî GAMME EDGE', keys: PRODUCTS.filter(p=>p.cat==='EDGE')},
        {label:'SMARTPHONES MOTOROLA ‚Äî GAMME E', keys: PRODUCTS.filter(p=>p.cat==='E')},
        {label:'ACCESSOIRES ‚Äî CHARGEURS', keys: PRODUCTS.filter(p=>p.cat==='CHARGEUR')},
        {label:'ACCESSOIRES ‚Äî AUDIO', keys: PRODUCTS.filter(p=>p.cat==='AUDIO')},
        {label:'ACCESSOIRES ‚Äî TRACKING', keys: PRODUCTS.filter(p=>p.cat==='TRACKING')},
      ];
      for (const grp of groupsV){
        if (grp.keys.length===0) continue;
        salesRoot.appendChild(sectionTitle(grp.label));
        grp.keys.forEach(p=>{
          const row = document.createElement('div');
          row.className = 'product-row';
          row.innerHTML = `
            <div class="product-name">${p.name}</div>
            <div class="counter">
              <button type="button" class="btn-circle btn-minus" aria-label="Retirer 1 ${p.name}" onclick="updateSales('${p.key}', -1)" id="btn-minus-${p.key}">‚àí</button>
              <div class="count" id="count-${p.key}">0</div>
              <button type="button" class="btn-circle btn-plus" aria-label="Ajouter 1 ${p.name}" onclick="updateSales('${p.key}', 1)">+</button>
            </div>
          `;
          salesRoot.appendChild(row);
        });
      }

      // Stock
      const stockRoot = $('stock-list');
      stockRoot.innerHTML = '';
      const groupsS = groupsV; // m√™mes groupes
      for (const grp of groupsS){
        const onlyTracked = grp.keys.filter(p=>p.stock);
        if (onlyTracked.length===0) continue;
        stockRoot.appendChild(sectionTitle(grp.label));
        onlyTracked.forEach(p=>{
          const qty = stock[p.key] || 0;
          const row = document.createElement('div');
          row.className = 'product-row';
          row.innerHTML = `
            <div class="product-name"><label for="stock-${p.key}">${p.name}</label></div>
            <div style="display:flex;align-items:center;">
              <input type="number" class="stock-input" value="${qty}" min="0" id="stock-${p.key}" onchange="updateStock('${p.key}', this.value)" inputmode="numeric" />
              <span class="status-badge" id="status-${p.key}"></span>
            </div>
          `;
          stockRoot.appendChild(row);
          setStatusBadge(p.key, qty);
        });
      }

      renderSalesCounts();
      updateTotals();
      renderReports();
    }

    function renderSalesCounts(){
      PRODUCTS.forEach(p=>{
        const n = sales[p.key] || 0;
        const el = $(`count-${p.key}`); if (el) el.textContent = n;
        const btn = $(`btn-minus-${p.key}`); if (btn) btn.disabled = n===0;
      });
    }

    // ========= Init =========
    document.addEventListener('DOMContentLoaded', () => {
      $('currentDate').value = currentDate;
      $('btn-export-json').addEventListener('click', exportJSON);
      $('btn-export-csv').addEventListener('click', exportCSV);
      // ‚úÖ bouton reset ventes (jour)
      $('btn-reset-sales').addEventListener('click', resetSalesCounters);

      loadGlobalStock();         // ‚¨ÖÔ∏è charge le stock global
      render();                  // ‚¨ÖÔ∏è construit l'UI (m√™me design)
      isInit = true;
      loadDay();                 // ‚¨ÖÔ∏è charge ventes/notes du JOUR (stock inchang√©)
      isInit = false;

      updateTotals();
      renderReports();

      $('currentDate').addEventListener('change', (e) => {
        currentDate = e.target.value || TODAY;
        isInit = true;
        loadDay();               // ‚¨ÖÔ∏è ne touche PAS au stock global
        isInit = false;
        updateTotals();
        renderReports();
      });

      ['observations','verbatims','interventions','dailySummary'].forEach(id=>{
        const el = $(id);
        el.addEventListener('input', ()=>{ saveDay(); renderReports(); });
      });
    });

    // ========= Ventes (affecte stock GLOBAL) =========
    function updateSales(key, change){
      const cur = sales[key] || 0;

      if (change > 0){
        const prod = PRODUCTS.find(p=>p.key===key);
        if (prod?.stock){
          const dispo = stock[key] || 0;
          if (dispo <= 0){ alert('Stock insuffisant'); return; }
          stock[key] = dispo - 1;
          const inp = $(`stock-${key}`); if (inp) inp.value = stock[key];
          setStatusBadge(key, stock[key]);
          saveGlobalStock();
        }
        sales[key] = cur + 1;
      } else if (change < 0 && cur > 0){
        sales[key] = cur - 1;
        const prod = PRODUCTS.find(p=>p.key===key);
        if (prod?.stock){
          stock[key] = (stock[key] || 0) + 1;
          const inp = $(`stock-${key}`); if (inp) inp.value = stock[key];
          setStatusBadge(key, stock[key]);
          saveGlobalStock();
        }
      }

      renderSalesCounts();
      updateTotals();
      saveDay();      // sauvegarde les ventes/notes du jour
      renderReports();
    }

    // ========= ‚úÖ R√©initialiser VENTES du jour (ne touche pas au stock) =========
    function resetSalesCounters(){
      const hasSales = Object.values(sales).some(v => (v||0) > 0);
      if (!hasSales){ alert("Aucune vente √† r√©initialiser pour ce jour."); return; }
      if (!confirm("R√©initialiser toutes les ventes du jour ? (Le stock global ne change pas)")) return;

      // Remet tous les compteurs √† 0 pour la date courante
      for (const k in sales){ sales[k] = 0; }
      renderSalesCounts();
      updateTotals();
      saveDay();
      renderReports();
      alert("Ventes du jour r√©initialis√©es.");
    }

    // ========= Stock GLOBAL (manuel) =========
    function updateStock(key, value){
      const q = Math.max(0, parseInt(value,10) || 0);
      stock[key] = q;
      setStatusBadge(key, q);
      if (!isInit) saveGlobalStock();
    }

    // ========= Sauvegarde jour =========
    function saveDay(){
      const payload = {
        date: currentDate,
        sales: { ...sales },
        observations: $('observations').value || '',
        verbatims: $('verbatims').value || '',
        interventions: $('interventions').value || '',
        dailySummary: $('dailySummary').value || ''
      };
      try{ localStorage.setItem(storageKey(currentDate), JSON.stringify(payload)); }
      catch(e){ console.warn('Sauvegarde jour KO', e); }
    }

    function loadDay(){
      // reset ventes & champs
      sales = Object.fromEntries(PRODUCTS.map(p=>[p.key,0]));
      ['observations','verbatims','interventions','dailySummary'].forEach(id=>{$(id).value='';});

      // ne touche PAS au stock global : on refl√®te juste la valeur
      PRODUCTS.filter(p=>p.stock).forEach(p=>{
        const inp = $(`stock-${p.key}`);
        if (inp){ inp.value = stock[p.key]||0; setStatusBadge(p.key, stock[p.key]||0); }
      });

      // boutons & compteurs
      renderSalesCounts();

      // charge ventes/notes du jour
      const raw = localStorage.getItem(storageKey(currentDate));
      if (!raw) return;
      try{
        const data = JSON.parse(raw);
        sales = { ...sales, ...(data.sales||{}) };
        renderSalesCounts();

        if (data.observations) $('observations').value = data.observations;
        if (data.verbatims) $('verbatims').value = data.verbatims;
        if (data.interventions) $('interventions').value = data.interventions;
        if (data.dailySummary) $('dailySummary').value = data.dailySummary;
      }catch(e){ console.warn('Lecture jour KO', e); }
    }

    // ========= Totaux & Rapports =========
    function updateTotals(){
      const total = Object.values(sales).reduce((a,b)=>a+(b||0),0);
      $('total-sales').textContent = total;

      const smartphones = PRODUCTS.filter(p=>p.type==='phone').reduce((s,p)=> s + (sales[p.key]||0), 0);
      $('smartphone-count').textContent = smartphones > 0 ? `dont ${smartphones} smartphones` : '';
    }

    function generateDailySummary(){
      const lines = [];
      const dateStr = safeDateStr(currentDate).toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
      lines.push(`**R√©sum√© des ventes ‚Äì ${dateStr} ‚Äì Fnac Toulouse Wilson**`, '');

      const sold = PRODUCTS.filter(p=> (sales[p.key]||0) > 0);
      if (sold.length === 0) lines.push('‚Ä¢ Aucune vente enregistr√©e');
      else sold.forEach(p => lines.push(`‚Ä¢ ${p.name} : ${sales[p.key]}`));

      const total = Object.values(sales).reduce((a,b)=>a+(b||0),0);
      const smartphones = PRODUCTS.filter(p=>p.type==='phone').reduce((s,p)=> s + (sales[p.key]||0), 0);
      lines.push('', `Total : ${total} ventes${smartphones ? ' dont ' + smartphones + ' smartphones' : ''}`, '', '**R√©sum√© de la journ√©e :**');

      const userSum = ($('dailySummary').value || '').trim();
      if (userSum) lines.push(userSum);
      else lines.push(total ? 'Bilan positif : activit√© et conversion tenues.' : "D√©but tranquille : mise en place & qualification.");

      return lines.join('\n');
    }

    function generateProfessionalReport(){
      const dateStr = safeDateStr(currentDate).toLocaleDateString('fr-FR');
      const total = Object.values(sales).reduce((a,b)=>a+(b||0),0);
      const smartphones = PRODUCTS.filter(p=>p.type==='phone').reduce((s,p)=> s + (sales[p.key]||0), 0);

      const issues = PRODUCTS.filter(p=>p.stock && (stock[p.key]||0)===0).length;

      const lines = [
        `**Rapport Professionnel ‚Äì ${dateStr}**`,
        '',
        '**KPI :**',
        `‚Ä¢ Total ventes : ${total}`,
        `‚Ä¢ Smartphones : ${smartphones}`,
        '',
        '**Stock (snapshot global) :**'
      ];
      PRODUCTS.filter(p=>p.stock).forEach(p=> lines.push(`‚Ä¢ ${p.name} : ${stock[p.key]||0}`));

      if (issues>0){
        lines.push('', '**Freins identifi√©s :**', `‚Ä¢ Ruptures sur ${issues} r√©f√©rence(s)`);
      }

      const obs = ($('observations').value||'').trim();
      const vb  = ($('verbatims').value||'').trim();
      const itv = ($('interventions').value||'').trim();
      if (obs){ lines.push('', '**Contexte :**', obs); }
      if (vb){  lines.push('', '**Verbatims clients :**', vb); }
      if (itv){ lines.push('', '**Interventions techniques :**', itv); }

      return lines.join('\n');
    }

    function renderReports(){
      $('daily-report').textContent = generateDailySummary();
      $('professional-report').textContent = generateProfessionalReport();
    }

    // ========= Export =========
    function buildPayload(){
      return {
        date: currentDate,
        sales: { ...sales },
        stock: { ...stock }, // snapshot du stock GLOBAL
        observations: $('observations').value || '',
        verbatims: $('verbatims').value || '',
        interventions: $('interventions').value || '',
        dailySummary: $('dailySummary').value || '',
        dailyReport: generateDailySummary(),
        professionalReport: generateProfessionalReport()
      };
    }

    function downloadBlob(content, filename, type='application/octet-stream'){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    function exportJSON(){
      const data = buildPayload();
      downloadBlob(JSON.stringify(data, null, 2), `motorola-${currentDate}.json`, 'application/json');
      alert('üì§ Export JSON termin√© !');
    }

    function exportCSV(){
      const data = buildPayload();
      const header = ['Date','Cat√©gorie','Produit','Ventes','Stock'];
      const rows = PRODUCTS.map(p => [
        data.date, p.cat, p.name, data.sales[p.key]||0, p.stock ? (data.stock[p.key]||0) : ''
      ]);
      const lines = [header, ...rows]
        .map(r => r.map(c => {
          const s = (c===null||c===undefined) ? '' : String(c);
          return /[;"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
        }).join(';'))
        .join('\n');

      downloadBlob(lines, `motorola-${currentDate}.csv`, 'text/csv;charset=utf-8');
      alert('üìë Export CSV termin√© !');
    }

    // ========= Copier =========
    function copyToClipboard(elementId){
      const el = $(elementId);
      const text = el ? el.textContent : '';
      if (!text) return;
      if (navigator.clipboard?.writeText){
        navigator.clipboard.writeText(text).then(()=>alert('üìã Copi√© !'));
      } else {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        alert('üìã Copi√© !');
      }
    }
  </script>
</body>
</html>